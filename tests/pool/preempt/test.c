
#include <pthread.h>

#ifdef __MUTEK__
# include <mutek/printk.h>
# include <hexo/power.h>
# include <device/class/timer.h>
#else
# include <stdio.h>
# define printk printf
#endif

#define THREAD_COUNT 8
#define TEST_CYCLES 16

#include <stdint.h>

pthread_mutex_t m;
pthread_barrier_t bar;
pthread_t pthread[THREAD_COUNT];
size_t done_cnt = 0;

struct device_timer_s timer_dev;
struct dev_timer_rq_s timer_rq;

/* use many registers to check that no register get destroyed during various context switchs */
uint32_t calc(uint32_t n)
{
  int i;
  uint32_t r0 = n, r1 = n, r2 = n, r3 = n, r4 = n, r5 = n, r6 = n, r7 = n, 
        r8 = n, r9 = n, r10 = n, r11 = n, r12 = n, r13 = n, r14 = n, r15 = n, 
        r16 = n, r17 = n, r18 = n, r19 = n, r20 = n, r21 = n, r22 = n, r23 = n, 
        r24 = n, r25 = n, r26 = n, r27 = n, r28 = n, r29 = n, r30 = n, r31 = n,
        r32 = n, r33 = n, r34 = n, r35 = n, r36 = n, r37 = n, r38 = n, r39 = n, r40 = n;

  for (i = 0; i < 16; i++)
    {
      uint16_t i = rand() % 256;
      while (i--)
        asm volatile("nop");

      r0 = 1 ^ (r0*2057780074) ^ (r1+1235911890) ^ (r2*817483546) ^ (r3*1593037595) ^ (r4*549924170) ^ (r5*824470113) ^ (r6*529974450) ^ (r7*1069423197) ^ (r8+1619813050) ^ (r9+208267785) ^ (r10*661080603) ^ (r11*875373828) ^ (r12*1869788140) ^ (r13*605831972) ^ (r14+1635216306) ^ (r15*1401335066) ^ (r16*1594397326) ^ (r17+1435478362) ^ (r18+964564068) ^ (r19*1154270059) ^ (r20*194831194) ^ (r21*1137888782) ^ (r22*153045706) ^ (r23*1909063095) ^ (r24*861471299) ^ (r25*940772577) ^ (r26+470959085) ^ (r27+499265296) ^ (r28+2142302020) ^ (r29+105238869) ^ (r30+339040672) ^ (r31+1977323591) ^ (r32*1431519694) ^ (r33*8121241) ^ (r34*1042059899) ^ (r35+1341087367) ^ (r36+1727013078) ^ (r37*436578925) ^ (r38+1583876482) ^ (r39*841094669);
      r1 = 1 ^ (r0*1240079745) ^ (r1*1891020836) ^ (r2*1846420314) ^ (r3+512397047) ^ (r4+65891957) ^ (r5+424057039) ^ (r6*627187500) ^ (r7+1953260097) ^ (r8*237087173) ^ (r9*1830791041) ^ (r10*781857057) ^ (r11+1681726679) ^ (r12*349158273) ^ (r13*319213749) ^ (r14+579925121) ^ (r15*1525999308) ^ (r16*2106160864) ^ (r17*1174968276) ^ (r18*487891824) ^ (r19+2016044209) ^ (r20+214024211) ^ (r21*572282332) ^ (r22*1055597134) ^ (r23+1800321289) ^ (r24+1861479599) ^ (r25*1025220387) ^ (r26*1717865651) ^ (r27+791260128) ^ (r28*529963198) ^ (r29*69049921) ^ (r30+2105971213) ^ (r31*1167531651) ^ (r32+365022827) ^ (r33*102652436) ^ (r34+2116653023) ^ (r35*882774354) ^ (r36+239730257) ^ (r37+1211628773) ^ (r38*778893215) ^ (r39*1130799545);
      r2 = 1 ^ (r0*96003687) ^ (r1+1320702640) ^ (r2*508767795) ^ (r3+1635223111) ^ (r4+1621304722) ^ (r5*1076286602) ^ (r6+1270723344) ^ (r7*1394388701) ^ (r8*50125262) ^ (r9*1358935844) ^ (r10+67697911) ^ (r11+1862782736) ^ (r12*836847362) ^ (r13*1537118836) ^ (r14+265034325) ^ (r15+1832958098) ^ (r16*258024552) ^ (r17+414144635) ^ (r18*1768080191) ^ (r19+1719045073) ^ (r20*1811467935) ^ (r21*10383658) ^ (r22+1535716112) ^ (r23*450094250) ^ (r24*1777024085) ^ (r25*1929965926) ^ (r26+1645182887) ^ (r27*2092910912) ^ (r28+1049113500) ^ (r29*1228669747) ^ (r30*1764205641) ^ (r31+680411374) ^ (r32*1962663375) ^ (r33*2105980149) ^ (r34*61494807) ^ (r35+642029924) ^ (r36*1280014377) ^ (r37*1369146841) ^ (r38+126453812) ^ (r39+1411547095);
      r3 = 1 ^ (r0+859209451) ^ (r1*1872700763) ^ (r2+555509119) ^ (r3*337851480) ^ (r4*1937068335) ^ (r5*1860697066) ^ (r6+933627376) ^ (r7+2109947214) ^ (r8*1121839958) ^ (r9*268317358) ^ (r10+1527416218) ^ (r11+9445638) ^ (r12+989132307) ^ (r13+1111363698) ^ (r14+2109131589) ^ (r15+826592112) ^ (r16*1929185307) ^ (r17*1169596837) ^ (r18+1575873709) ^ (r19*783082989) ^ (r20*1347393650) ^ (r21*547144067) ^ (r22*211533412) ^ (r23*794199885) ^ (r24+1028833114) ^ (r25+1645132378) ^ (r26+1494662472) ^ (r27+1297924573) ^ (r28+525632482) ^ (r29*990827247) ^ (r30+579084201) ^ (r31*7255460) ^ (r32*462951441) ^ (r33*397098758) ^ (r34+142048259) ^ (r35*63302838) ^ (r36*1720903094) ^ (r37*1348471049) ^ (r38+2056000347) ^ (r39+136570793);
      r4 = 1 ^ (r0+1448566229) ^ (r1*402369224) ^ (r2+364408128) ^ (r3+1363796012) ^ (r4*1092107448) ^ (r5*2077305703) ^ (r6*530420585) ^ (r7*147777472) ^ (r8+254520472) ^ (r9*2146089055) ^ (r10*464640750) ^ (r11*434088070) ^ (r12+1872654575) ^ (r13+1784532899) ^ (r14*830720301) ^ (r15+208678464) ^ (r16*1742689380) ^ (r17+418787564) ^ (r18+973881923) ^ (r19*853228891) ^ (r20+955290457) ^ (r21+1648815126) ^ (r22+1304416043) ^ (r23+955506225) ^ (r24+1132503324) ^ (r25*2079392433) ^ (r26*1701144959) ^ (r27*189588053) ^ (r28*49104305) ^ (r29*380973725) ^ (r30*1246616273) ^ (r31*856640015) ^ (r32+908309057) ^ (r33+1456644053) ^ (r34*2063162798) ^ (r35+507744239) ^ (r36+1261292073) ^ (r37+996553557) ^ (r38*1227476536) ^ (r39*1544749189);
      r5 = 1 ^ (r0*1269333673) ^ (r1*1997972766) ^ (r2+359553125) ^ (r3+1012753463) ^ (r4*1744354095) ^ (r5+846677855) ^ (r6*1610756576) ^ (r7*1814847796) ^ (r8+1568407624) ^ (r9*1179633846) ^ (r10+855805315) ^ (r11+1697717133) ^ (r12*2009557803) ^ (r13+8471452) ^ (r14*539530870) ^ (r15+733067626) ^ (r16+988514281) ^ (r17*514920680) ^ (r18+1811603696) ^ (r19+1614516578) ^ (r20*524610621) ^ (r21+1901589362) ^ (r22*929980048) ^ (r23+1530128620) ^ (r24+1866545397) ^ (r25+1097880288) ^ (r26*1121027167) ^ (r27+136071418) ^ (r28+726515714) ^ (r29+31480711) ^ (r30+725413998) ^ (r31*858820269) ^ (r32*1954589993) ^ (r33+1225062767) ^ (r34*2118352142) ^ (r35+1242299947) ^ (r36*1578577743) ^ (r37+965788801) ^ (r38*1406685113) ^ (r39+1231011221);
      r6 = 1 ^ (r0+557498467) ^ (r1*761664453) ^ (r2*2147225988) ^ (r3*915947037) ^ (r4*474302962) ^ (r5+541953485) ^ (r6*1046159174) ^ (r7+448280892) ^ (r8+462390356) ^ (r9*1485483062) ^ (r10+691871569) ^ (r11+667879432) ^ (r12+1482067575) ^ (r13+1802881109) ^ (r14*2023426770) ^ (r15*1986345644) ^ (r16*320166989) ^ (r17*1569679095) ^ (r18+428038352) ^ (r19*1948612090) ^ (r20*7092703) ^ (r21+1460836681) ^ (r22+46438598) ^ (r23*252230947) ^ (r24*1996243190) ^ (r25*621045982) ^ (r26+1774545638) ^ (r27+1686400399) ^ (r28+1410744169) ^ (r29*1715234007) ^ (r30*924673012) ^ (r31*214258383) ^ (r32+1298410512) ^ (r33+1292273190) ^ (r34+2039286467) ^ (r35+788945079) ^ (r36+1701439564) ^ (r37+2011742451) ^ (r38*1761328470) ^ (r39*464159121);
      r7 = 1 ^ (r0*1014869049) ^ (r1+333887784) ^ (r2+1908992926) ^ (r3*252765812) ^ (r4*575282042) ^ (r5+997470225) ^ (r6+1218622933) ^ (r7+524199867) ^ (r8*1034657959) ^ (r9*1749213476) ^ (r10+1272355964) ^ (r11+915788698) ^ (r12*409488733) ^ (r13+442147815) ^ (r14+1112641534) ^ (r15+1828808915) ^ (r16+1451039978) ^ (r17+697485559) ^ (r18*1910722025) ^ (r19*1130740622) ^ (r20+941954971) ^ (r21*582076460) ^ (r22*326474188) ^ (r23*887202382) ^ (r24*318141612) ^ (r25+1078752739) ^ (r26+1885503419) ^ (r27*513798408) ^ (r28*672626900) ^ (r29*1612191068) ^ (r30*831352420) ^ (r31+264366166) ^ (r32+1480617843) ^ (r33+2095234634) ^ (r34+788109012) ^ (r35*862609106) ^ (r36+1151450209) ^ (r37*1592503154) ^ (r38+1525456851) ^ (r39*155617926);
      r8 = 1 ^ (r0+2121573469) ^ (r1*553724020) ^ (r2*1105156831) ^ (r3+1027371143) ^ (r4*748358166) ^ (r5+1337717933) ^ (r6*1110362321) ^ (r7+1665671337) ^ (r8*1943928289) ^ (r9*378016069) ^ (r10*458120209) ^ (r11+220726101) ^ (r12+1035247104) ^ (r13+1728647245) ^ (r14*969475711) ^ (r15+1181065087) ^ (r16*2074371475) ^ (r17*602675976) ^ (r18*927547625) ^ (r19+279666363) ^ (r20*551659558) ^ (r21+662963539) ^ (r22+365484587) ^ (r23*340850040) ^ (r24+1702533087) ^ (r25+1706812456) ^ (r26+1250950127) ^ (r27+464991565) ^ (r28*11064394) ^ (r29+1126350149) ^ (r30*644838153) ^ (r31*496054135) ^ (r32+1669668811) ^ (r33+2033124850) ^ (r34+138733942) ^ (r35+2058595692) ^ (r36+954628520) ^ (r37*695912168) ^ (r38*922247162) ^ (r39+362096017);
      r9 = 1 ^ (r0+1733393080) ^ (r1+331438933) ^ (r2*945870172) ^ (r3*544174607) ^ (r4*1093038772) ^ (r5+804643077) ^ (r6+1618651464) ^ (r7*1158787020) ^ (r8*777282593) ^ (r9*1073581987) ^ (r10+464840904) ^ (r11*1594084222) ^ (r12+1079811295) ^ (r13*43207973) ^ (r14+1098076774) ^ (r15+734421729) ^ (r16*1644579161) ^ (r17*532280654) ^ (r18+2027519977) ^ (r19+30982161) ^ (r20*576913489) ^ (r21*973662805) ^ (r22+1193821107) ^ (r23*2145637627) ^ (r24*1733616975) ^ (r25+1747625132) ^ (r26+671672252) ^ (r27*1377058038) ^ (r28*759472046) ^ (r29+238491619) ^ (r30*783457334) ^ (r31+1114532471) ^ (r32*750847051) ^ (r33*1280041651) ^ (r34*176489414) ^ (r35*232736489) ^ (r36*1979445203) ^ (r37*570581024) ^ (r38+941583202) ^ (r39+1964550818);
      r10 = 1 ^ (r0*1981771697) ^ (r1*910675902) ^ (r2+214358996) ^ (r3+638333690) ^ (r4+837547929) ^ (r5+1472588573) ^ (r6*917885650) ^ (r7*1596988543) ^ (r8+1351877052) ^ (r9+144334407) ^ (r10+559354305) ^ (r11+751363915) ^ (r12+1006311312) ^ (r13+2075244910) ^ (r14*907120653) ^ (r15+1012378494) ^ (r16+16638275) ^ (r17+601264556) ^ (r18*214843182) ^ (r19*1126704080) ^ (r20+970357188) ^ (r21+1535616747) ^ (r22+1415638594) ^ (r23+686462023) ^ (r24*1655432566) ^ (r25*504366315) ^ (r26*1646017354) ^ (r27*40686350) ^ (r28*528820602) ^ (r29+424293738) ^ (r30+917839883) ^ (r31*620943726) ^ (r32*1271931296) ^ (r33+1963702630) ^ (r34*819284106) ^ (r35+1495425757) ^ (r36+1561449202) ^ (r37+680533895) ^ (r38+485753132) ^ (r39*406732860);
      r11 = 1 ^ (r0*684300517) ^ (r1*209399200) ^ (r2*635710064) ^ (r3+455943463) ^ (r4+1269967653) ^ (r5+1951380317) ^ (r6+395984979) ^ (r7+1568462189) ^ (r8*385554947) ^ (r9+2107948031) ^ (r10+966796103) ^ (r11+387823783) ^ (r12+1970470790) ^ (r13*622130506) ^ (r14*974975192) ^ (r15*116652525) ^ (r16+1535525652) ^ (r17*503071113) ^ (r18*2095438308) ^ (r19*1647475115) ^ (r20+336588228) ^ (r21+1706396336) ^ (r22+1499038845) ^ (r23+1074853786) ^ (r24*568438089) ^ (r25+776932519) ^ (r26*695347045) ^ (r27+932313811) ^ (r28*557695876) ^ (r29+1454730415) ^ (r30*1982016814) ^ (r31*1942363654) ^ (r32+2044805295) ^ (r33*1548096485) ^ (r34*1214106868) ^ (r35*1047102928) ^ (r36+206472746) ^ (r37*514810604) ^ (r38+1620879040) ^ (r39*721250098);
      r12 = 1 ^ (r0*342339565) ^ (r1*606172336) ^ (r2+205066628) ^ (r3+1304077350) ^ (r4*515252880) ^ (r5*808732238) ^ (r6*1772972213) ^ (r7+1879811157) ^ (r8*1100487682) ^ (r9*816855576) ^ (r10*1659258769) ^ (r11*1405267947) ^ (r12+1251394764) ^ (r13+1941179324) ^ (r14+478232565) ^ (r15*1763652243) ^ (r16*855564297) ^ (r17+329739149) ^ (r18*1173502690) ^ (r19+1644653703) ^ (r20+203151341) ^ (r21*102995681) ^ (r22+2057392277) ^ (r23*1287993287) ^ (r24+2143847671) ^ (r25+412836770) ^ (r26*1858700873) ^ (r27*104048499) ^ (r28*806006205) ^ (r29+724718825) ^ (r30+299204498) ^ (r31+1354786619) ^ (r32+1623055707) ^ (r33*150892237) ^ (r34*1321849183) ^ (r35*185524474) ^ (r36*932171391) ^ (r37+1812111170) ^ (r38+2073904277) ^ (r39*1015828075);
      r13 = 1 ^ (r0*224151835) ^ (r1*2007478821) ^ (r2*30275148) ^ (r3*2080046331) ^ (r4*854585520) ^ (r5*561505885) ^ (r6+1789846447) ^ (r7+1577593286) ^ (r8+318841148) ^ (r9+377838115) ^ (r10*1685327740) ^ (r11+1350761382) ^ (r12*1248041160) ^ (r13+1531815018) ^ (r14+1535905565) ^ (r15*1071923565) ^ (r16*1790921625) ^ (r17*826085730) ^ (r18*100429161) ^ (r19*2091235899) ^ (r20+1174692089) ^ (r21+860493856) ^ (r22*1239085316) ^ (r23*780979698) ^ (r24+2048259753) ^ (r25*731758432) ^ (r26*1480619095) ^ (r27*1168620495) ^ (r28*995289326) ^ (r29+637519731) ^ (r30+1959959860) ^ (r31*1366123803) ^ (r32+241139004) ^ (r33+1390776124) ^ (r34*1189110289) ^ (r35*710343175) ^ (r36+410807691) ^ (r37*11586140) ^ (r38+1101654759) ^ (r39*1669852829);
      r14 = 1 ^ (r0+1114599997) ^ (r1+1828666998) ^ (r2+1097268143) ^ (r3+1758182875) ^ (r4*321325234) ^ (r5+1443290517) ^ (r6*731362946) ^ (r7+1736057058) ^ (r8*427218033) ^ (r9+955888563) ^ (r10*1120019282) ^ (r11*852590676) ^ (r12+170629370) ^ (r13+963853659) ^ (r14*1838386001) ^ (r15+271353285) ^ (r16*1910860340) ^ (r17*136109430) ^ (r18+2064602597) ^ (r19+1967313744) ^ (r20+793006456) ^ (r21*992561196) ^ (r22+715502926) ^ (r23+8783697) ^ (r24*1184843073) ^ (r25+924768488) ^ (r26*2002456797) ^ (r27+901993018) ^ (r28+1331097978) ^ (r29*1153886599) ^ (r30*1312144089) ^ (r31*2040464518) ^ (r32+75329130) ^ (r33*454844562) ^ (r34+1972510712) ^ (r35+1969396434) ^ (r36*1302438981) ^ (r37*148753583) ^ (r38+778452607) ^ (r39+269413908);
      r15 = 1 ^ (r0+95467866) ^ (r1*1847034655) ^ (r2*25416448) ^ (r3+1037258220) ^ (r4+1605470429) ^ (r5*900749160) ^ (r6+657279159) ^ (r7+235891486) ^ (r8*205373528) ^ (r9+1793040923) ^ (r10*41163655) ^ (r11*33626153) ^ (r12+1302979003) ^ (r13*93678777) ^ (r14*1836579230) ^ (r15+1095763449) ^ (r16+1483278342) ^ (r17+409319607) ^ (r18*123507371) ^ (r19*1240515264) ^ (r20*1812130967) ^ (r21*496367529) ^ (r22*1044947649) ^ (r23+410345707) ^ (r24+931810076) ^ (r25*1084222083) ^ (r26*1654351571) ^ (r27*1022708793) ^ (r28+830956063) ^ (r29*1828142594) ^ (r30+1314801874) ^ (r31+626979566) ^ (r32+593358385) ^ (r33+926898738) ^ (r34*74396014) ^ (r35+73730348) ^ (r36*905420220) ^ (r37*1854208786) ^ (r38*2073333104) ^ (r39+1450069099);
      r16 = 1 ^ (r0*1099668337) ^ (r1*1755007067) ^ (r2+2118038713) ^ (r3+874106119) ^ (r4+190410066) ^ (r5+1183728230) ^ (r6+969605346) ^ (r7+36365311) ^ (r8*1186530918) ^ (r9*693402163) ^ (r10+793477496) ^ (r11*1697061574) ^ (r12*1167821055) ^ (r13+1051208334) ^ (r14*163765211) ^ (r15+901606202) ^ (r16*1881135026) ^ (r17*1800661076) ^ (r18+1309574330) ^ (r19+2052152761) ^ (r20*567522010) ^ (r21*308887516) ^ (r22+2030182710) ^ (r23+400403291) ^ (r24*1916649681) ^ (r25*1424471418) ^ (r26*1344109977) ^ (r27+485567043) ^ (r28*402554549) ^ (r29*1584447270) ^ (r30+912992185) ^ (r31+518908438) ^ (r32*1658173402) ^ (r33+987852097) ^ (r34+488135414) ^ (r35*1678608022) ^ (r36*935838170) ^ (r37*1294768256) ^ (r38+802655189) ^ (r39*1377752655);
      r17 = 1 ^ (r0+1209621310) ^ (r1+783846121) ^ (r2+2143125823) ^ (r3+1184381816) ^ (r4*42117839) ^ (r5+1391540739) ^ (r6+1906674018) ^ (r7*1385626845) ^ (r8+376536454) ^ (r9+768886803) ^ (r10+1793325099) ^ (r11+1960258817) ^ (r12+35160340) ^ (r13*1830167177) ^ (r14+566672742) ^ (r15+2058929481) ^ (r16+33347863) ^ (r17*121615233) ^ (r18*1723498619) ^ (r19+2082847579) ^ (r20*643108066) ^ (r21*1709849710) ^ (r22*1820282830) ^ (r23+2126640781) ^ (r24+544992240) ^ (r25+1093341146) ^ (r26+1430950330) ^ (r27+727264129) ^ (r28+2006427373) ^ (r29+426967121) ^ (r30+295994674) ^ (r31+589284310) ^ (r32+1812003689) ^ (r33*666729061) ^ (r34+870203389) ^ (r35*221452289) ^ (r36*1871704098) ^ (r37*487153618) ^ (r38*1976154260) ^ (r39+1374839106);
      r18 = 1 ^ (r0*1180385268) ^ (r1*987355594) ^ (r2+294128034) ^ (r3*2037180859) ^ (r4+1179464040) ^ (r5+2114418771) ^ (r6+728415520) ^ (r7+442179747) ^ (r8*684996831) ^ (r9+1754928341) ^ (r10+564890899) ^ (r11*872896672) ^ (r12+998728545) ^ (r13+165285304) ^ (r14+1422043115) ^ (r15*1901073979) ^ (r16+863381519) ^ (r17+1717801266) ^ (r18+470165122) ^ (r19+1437135988) ^ (r20*1504239145) ^ (r21*1005112616) ^ (r22+127795638) ^ (r23*1691370878) ^ (r24+1387443652) ^ (r25+177732146) ^ (r26*39220653) ^ (r27+1190573453) ^ (r28*1639952660) ^ (r29*65558473) ^ (r30*18309291) ^ (r31*1467176404) ^ (r32*836811866) ^ (r33+1157975942) ^ (r34*1717685146) ^ (r35*1945212307) ^ (r36*2099094130) ^ (r37+424220040) ^ (r38*2009950750) ^ (r39*1265618773);
      r19 = 1 ^ (r0+749222916) ^ (r1+1012415488) ^ (r2*1773568090) ^ (r3*58994751) ^ (r4+2064504653) ^ (r5*2123747280) ^ (r6+935410764) ^ (r7*1095950219) ^ (r8+1762883218) ^ (r9+720614485) ^ (r10+1797927113) ^ (r11*1384868892) ^ (r12*1185358633) ^ (r13*833950798) ^ (r14+1806450718) ^ (r15+935634484) ^ (r16+932983595) ^ (r17+1437654494) ^ (r18+749921355) ^ (r19+818228042) ^ (r20*1650589633) ^ (r21*1277190068) ^ (r22+205284069) ^ (r23*1859389950) ^ (r24+1177299474) ^ (r25*1663712594) ^ (r26*786045583) ^ (r27*1764754486) ^ (r28*347679951) ^ (r29+138678387) ^ (r30*1581627421) ^ (r31+845485386) ^ (r32+514300003) ^ (r33+1918184846) ^ (r34+229163342) ^ (r35*1988559459) ^ (r36+180090819) ^ (r37*1062936960) ^ (r38+899187501) ^ (r39*477944555);
      r20 = 1 ^ (r0*1362688982) ^ (r1+323788367) ^ (r2*1435177483) ^ (r3+1738829605) ^ (r4+186198920) ^ (r5*2100931857) ^ (r6+1523231012) ^ (r7+2034623205) ^ (r8*238351993) ^ (r9*894442227) ^ (r10+223041492) ^ (r11*1723245153) ^ (r12+1707714629) ^ (r13+1033451358) ^ (r14*1994623612) ^ (r15*1002970926) ^ (r16*1393384057) ^ (r17*958011708) ^ (r18*350395646) ^ (r19*290577231) ^ (r20*438412057) ^ (r21*1218036065) ^ (r22+1215907033) ^ (r23+1131374704) ^ (r24*694836696) ^ (r25*516984845) ^ (r26*2004762859) ^ (r27*1451893049) ^ (r28+917474781) ^ (r29+1917494166) ^ (r30*577658057) ^ (r31*261849798) ^ (r32+1327560246) ^ (r33+988993067) ^ (r34*1773761989) ^ (r35+1667247162) ^ (r36+1005561572) ^ (r37+992882876) ^ (r38+1293864837) ^ (r39*1737796219);
      r21 = 1 ^ (r0*1901943947) ^ (r1*2110245118) ^ (r2*1672062531) ^ (r3*1156339200) ^ (r4*1283141821) ^ (r5+1976246419) ^ (r6*1466666157) ^ (r7+1918871759) ^ (r8+1962457322) ^ (r9+619658062) ^ (r10+419218274) ^ (r11*1389531787) ^ (r12*855265774) ^ (r13*662618780) ^ (r14*900945934) ^ (r15+990671026) ^ (r16+294712894) ^ (r17+651799559) ^ (r18*555564) ^ (r19*732590317) ^ (r20*1069522105) ^ (r21*1491269853) ^ (r22+963122014) ^ (r23+725238663) ^ (r24+1285144079) ^ (r25*1275675894) ^ (r26+592007539) ^ (r27*270935048) ^ (r28+898907865) ^ (r29*1950022299) ^ (r30+1955557373) ^ (r31+514612707) ^ (r32*624794685) ^ (r33+975118730) ^ (r34+527478676) ^ (r35+954438483) ^ (r36*1859901764) ^ (r37*645521183) ^ (r38+18745524) ^ (r39+1474964557);
      r22 = 1 ^ (r0+25578178) ^ (r1*819453333) ^ (r2*1925236791) ^ (r3*1576170390) ^ (r4*299302889) ^ (r5+2039869554) ^ (r6+1690035064) ^ (r7*1325795324) ^ (r8*685974898) ^ (r9*1631218697) ^ (r10+555053581) ^ (r11*238708650) ^ (r12+342581617) ^ (r13*217826849) ^ (r14+1713462055) ^ (r15*281377692) ^ (r16+1338295741) ^ (r17*459027900) ^ (r18*714663055) ^ (r19+671885626) ^ (r20+1970837249) ^ (r21*1796483067) ^ (r22*568029512) ^ (r23+763760650) ^ (r24+1805960810) ^ (r25*255688741) ^ (r26+1774411204) ^ (r27+1128839558) ^ (r28*1935711221) ^ (r29+15710414) ^ (r30*15108045) ^ (r31*207200532) ^ (r32+913354588) ^ (r33+157359133) ^ (r34+535080954) ^ (r35*682203675) ^ (r36+621473190) ^ (r37+793471278) ^ (r38+1680769747) ^ (r39*1475689018);
      r23 = 1 ^ (r0*1945045328) ^ (r1+1809996959) ^ (r2+1175893898) ^ (r3+148180380) ^ (r4*877220643) ^ (r5+1245753903) ^ (r6*1688425055) ^ (r7+674069360) ^ (r8+861247900) ^ (r9+686577033) ^ (r10*588757144) ^ (r11+151609469) ^ (r12*237325562) ^ (r13*655661095) ^ (r14+1882252321) ^ (r15*64718298) ^ (r16*1793574383) ^ (r17*865428057) ^ (r18+757834959) ^ (r19*1783249347) ^ (r20+792538350) ^ (r21+230192493) ^ (r22*1351187764) ^ (r23+1545957519) ^ (r24+1796481046) ^ (r25+943846641) ^ (r26+1640188199) ^ (r27+186315719) ^ (r28*1073206721) ^ (r29*95391005) ^ (r30*1230076891) ^ (r31*860177752) ^ (r32*1109924275) ^ (r33+1976675413) ^ (r34+2068341664) ^ (r35*1257307376) ^ (r36+2113282794) ^ (r37+70018514) ^ (r38*2010874179) ^ (r39+1040811375);
      r24 = 1 ^ (r0+1095819271) ^ (r1*1157215080) ^ (r2*1208852743) ^ (r3*1772699772) ^ (r4*1976105054) ^ (r5*2069425259) ^ (r6*2000945990) ^ (r7+2020226625) ^ (r8+1732272040) ^ (r9+995059635) ^ (r10+1543602863) ^ (r11+1550554937) ^ (r12*1368586826) ^ (r13+819748551) ^ (r14*5981733) ^ (r15*1521317420) ^ (r16*74281034) ^ (r17*1671841823) ^ (r18*1768107064) ^ (r19+1015496773) ^ (r20*2128407766) ^ (r21+332529290) ^ (r22+1298972235) ^ (r23+498506050) ^ (r24*2022058104) ^ (r25*1032072118) ^ (r26*995629387) ^ (r27+1811112402) ^ (r28*662944738) ^ (r29+142838742) ^ (r30*1989335568) ^ (r31+1245367813) ^ (r32+1883986267) ^ (r33*428785766) ^ (r34*400669530) ^ (r35*1312723428) ^ (r36*1866934987) ^ (r37+1247447059) ^ (r38+1139159922) ^ (r39+666257961);
      r25 = 1 ^ (r0*246166128) ^ (r1*2029343167) ^ (r2*894566243) ^ (r3*64513810) ^ (r4+421538854) ^ (r5+446382249) ^ (r6*393685467) ^ (r7+85786454) ^ (r8+1805192532) ^ (r9+1375328177) ^ (r10+1912454060) ^ (r11*1891635521) ^ (r12+623239553) ^ (r13*1956422081) ^ (r14+295756769) ^ (r15+1180817380) ^ (r16*1319395707) ^ (r17*64769359) ^ (r18*462161286) ^ (r19*2126707309) ^ (r20*560481064) ^ (r21*1850724616) ^ (r22+1860483328) ^ (r23*521108382) ^ (r24+53010419) ^ (r25*1485524879) ^ (r26+1306619660) ^ (r27*2123788129) ^ (r28*1304915932) ^ (r29+1175097452) ^ (r30+1461519200) ^ (r31+1800248448) ^ (r32*390838052) ^ (r33*849150985) ^ (r34*1212558564) ^ (r35*1245139066) ^ (r36+1416537244) ^ (r37*1688692957) ^ (r38*1786141076) ^ (r39*768461689);
      r26 = 1 ^ (r0*1188167314) ^ (r1+1915963316) ^ (r2+168174588) ^ (r3+1444596328) ^ (r4*909761631) ^ (r5*1294900494) ^ (r6*1228812375) ^ (r7+1513805098) ^ (r8+1046497943) ^ (r9*864953772) ^ (r10*376037197) ^ (r11+903550702) ^ (r12+602740694) ^ (r13+291169331) ^ (r14+540402768) ^ (r15*1088792230) ^ (r16*1264281644) ^ (r17+1311741423) ^ (r18*1787260314) ^ (r19+1009468830) ^ (r20*1388596525) ^ (r21+1819077825) ^ (r22+1807297486) ^ (r23*696957488) ^ (r24+1883324576) ^ (r25*1804829724) ^ (r26+1980376880) ^ (r27+1291652254) ^ (r28+1820524490) ^ (r29*467707697) ^ (r30+682029195) ^ (r31*1881869313) ^ (r32+888202590) ^ (r33+681516595) ^ (r34+1253071782) ^ (r35+870556006) ^ (r36*147488779) ^ (r37*1874286782) ^ (r38*177967467) ^ (r39+1209243392);
      r27 = 1 ^ (r0*1710801833) ^ (r1+2097834841) ^ (r2+886957981) ^ (r3*1474206080) ^ (r4+656265994) ^ (r5*1512666659) ^ (r6*195791932) ^ (r7+642668937) ^ (r8+1302462562) ^ (r9*405219986) ^ (r10+172143231) ^ (r11*2027410247) ^ (r12*1721385563) ^ (r13+11748958) ^ (r14+1114476406) ^ (r15*1037558311) ^ (r16*1158675391) ^ (r17*42465669) ^ (r18*842273859) ^ (r19*1111451305) ^ (r20*973837258) ^ (r21+1989102960) ^ (r22*1606611963) ^ (r23*1830052954) ^ (r24+1265302804) ^ (r25*539673404) ^ (r26*1039672101) ^ (r27*1766890982) ^ (r28+346220833) ^ (r29+1523679004) ^ (r30*107847383) ^ (r31+2099205458) ^ (r32*481101453) ^ (r33+652834530) ^ (r34+1440868721) ^ (r35+1152054864) ^ (r36*87508959) ^ (r37+309737892) ^ (r38+1528974080) ^ (r39+548442291);
      r28 = 1 ^ (r0*155701488) ^ (r1+1091831427) ^ (r2+1253933880) ^ (r3+1309288713) ^ (r4+1805043968) ^ (r5+1087899792) ^ (r6*879115029) ^ (r7+963773776) ^ (r8*326823774) ^ (r9+1681305040) ^ (r10+1101734935) ^ (r11+1309162440) ^ (r12*1695510714) ^ (r13+1998532455) ^ (r14*908546849) ^ (r15*264301040) ^ (r16*382802705) ^ (r17*1613725913) ^ (r18*858260726) ^ (r19*217356693) ^ (r20*989244989) ^ (r21+1432222836) ^ (r22+1704827480) ^ (r23*1509259789) ^ (r24+2044438302) ^ (r25+1389773522) ^ (r26+1420048837) ^ (r27+1256928137) ^ (r28+127304561) ^ (r29*103605123) ^ (r30*1587881175) ^ (r31+762067600) ^ (r32+568532019) ^ (r33*10061007) ^ (r34*2124705600) ^ (r35+1953933712) ^ (r36*1804031162) ^ (r37+398024865) ^ (r38+1281320295) ^ (r39+1017890454);
      r29 = 1 ^ (r0+333708377) ^ (r1+311692425) ^ (r2*940478635) ^ (r3+136870695) ^ (r4+253583541) ^ (r5+995795681) ^ (r6+462087994) ^ (r7+455222319) ^ (r8*1573826225) ^ (r9+1723695895) ^ (r10+1105221012) ^ (r11+1823621150) ^ (r12+1227939835) ^ (r13+1725890322) ^ (r14+228618154) ^ (r15+538222875) ^ (r16+245470009) ^ (r17+1996057526) ^ (r18+1294907286) ^ (r19+237693272) ^ (r20*505924828) ^ (r21+820325002) ^ (r22*1617201151) ^ (r23*1870477196) ^ (r24+731135623) ^ (r25+1608999554) ^ (r26*1877823507) ^ (r27*2085292423) ^ (r28*1606964003) ^ (r29+196361696) ^ (r30+641494824) ^ (r31*682654439) ^ (r32+875224459) ^ (r33+1081582395) ^ (r34*1939643896) ^ (r35+1921721841) ^ (r36+133883863) ^ (r37*941981610) ^ (r38*808809344) ^ (r39+1070009475);
      r30 = 1 ^ (r0+1722335568) ^ (r1*124180482) ^ (r2+1000223612) ^ (r3+774836014) ^ (r4*1984104695) ^ (r5+1817376579) ^ (r6+189641865) ^ (r7+400922729) ^ (r8*301535930) ^ (r9+1273245722) ^ (r10+1066257376) ^ (r11+1030308328) ^ (r12+22390076) ^ (r13*937281416) ^ (r14+254626995) ^ (r15*295590419) ^ (r16+1506061895) ^ (r17+46448296) ^ (r18*1889421614) ^ (r19*98652058) ^ (r20+1406413785) ^ (r21*700404118) ^ (r22+1428087572) ^ (r23+1774659886) ^ (r24+1695295441) ^ (r25+1103569267) ^ (r26*1469684220) ^ (r27+537415507) ^ (r28+1288913981) ^ (r29*565714830) ^ (r30+582395184) ^ (r31+2050952792) ^ (r32+2134701641) ^ (r33*1317695398) ^ (r34+1271039785) ^ (r35+1338398321) ^ (r36+443821518) ^ (r37+160405330) ^ (r38*1681303729) ^ (r39+792616931);
      r31 = 1 ^ (r0*1062782844) ^ (r1*1861972105) ^ (r2+1366780317) ^ (r3+1512831334) ^ (r4*2121779117) ^ (r5+1886876998) ^ (r6*1063236910) ^ (r7*1357670033) ^ (r8+1348860880) ^ (r9+1427839564) ^ (r10+2048182284) ^ (r11+988992630) ^ (r12*575815800) ^ (r13+755371793) ^ (r14+268269031) ^ (r15*437619287) ^ (r16*2046839303) ^ (r17+270620861) ^ (r18*87481523) ^ (r19+1270357112) ^ (r20+300314113) ^ (r21*1079664218) ^ (r22*1142756230) ^ (r23*2046625563) ^ (r24+125864697) ^ (r25+689904654) ^ (r26+102302487) ^ (r27+1241266065) ^ (r28+1638911258) ^ (r29*924636043) ^ (r30*243086814) ^ (r31*1348807030) ^ (r32*668118364) ^ (r33*2036510609) ^ (r34+1852968396) ^ (r35+1343380989) ^ (r36*784476492) ^ (r37*858779794) ^ (r38*1114009006) ^ (r39*1879642994);
      r32 = 1 ^ (r0*1471205758) ^ (r1+1560369276) ^ (r2*449610794) ^ (r3+1212891847) ^ (r4*212200602) ^ (r5+587443100) ^ (r6*1689978461) ^ (r7*1021512013) ^ (r8*1536855304) ^ (r9*604585125) ^ (r10*1392101399) ^ (r11*549831820) ^ (r12+381163329) ^ (r13*1906219481) ^ (r14+313343934) ^ (r15+1354384950) ^ (r16*1048532668) ^ (r17+285118791) ^ (r18*601826243) ^ (r19+292595261) ^ (r20*945086329) ^ (r21*747627067) ^ (r22+1328213964) ^ (r23+831740172) ^ (r24+900930102) ^ (r25*1265045948) ^ (r26*108773222) ^ (r27+484986842) ^ (r28+1488189748) ^ (r29*991754295) ^ (r30+346917997) ^ (r31+1388185890) ^ (r32+845411245) ^ (r33+1900461634) ^ (r34+1923514115) ^ (r35*402364216) ^ (r36+1828554204) ^ (r37*1277042307) ^ (r38+834510129) ^ (r39*1381745406);
      r33 = 1 ^ (r0+1281889201) ^ (r1+1653662391) ^ (r2*1117964327) ^ (r3*1925353661) ^ (r4+79604760) ^ (r5*370979287) ^ (r6*2065208595) ^ (r7*710511894) ^ (r8*299551469) ^ (r9*2108712285) ^ (r10+793456552) ^ (r11*961701919) ^ (r12+847566726) ^ (r13*1734753197) ^ (r14*1057494070) ^ (r15*1559790738) ^ (r16*580894181) ^ (r17+1282039191) ^ (r18+724635497) ^ (r19+1228489001) ^ (r20*1007067265) ^ (r21*1374113025) ^ (r22+572101032) ^ (r23+35643918) ^ (r24*1451442360) ^ (r25+343798443) ^ (r26+2108687379) ^ (r27+202186870) ^ (r28*1122065371) ^ (r29*2025922834) ^ (r30+637889825) ^ (r31+64194133) ^ (r32+5167837) ^ (r33+1602519678) ^ (r34+898912988) ^ (r35*645454900) ^ (r36*412242594) ^ (r37*732760096) ^ (r38*271870147) ^ (r39+1296699175);
      r34 = 1 ^ (r0+801698537) ^ (r1+1505038428) ^ (r2+1569929027) ^ (r3*1985090787) ^ (r4+770875869) ^ (r5*241211949) ^ (r6*905087706) ^ (r7*826110965) ^ (r8+540451398) ^ (r9+1598946222) ^ (r10+1265899728) ^ (r11+1902327317) ^ (r12+136102479) ^ (r13*138785213) ^ (r14*1627285403) ^ (r15+1496394400) ^ (r16+1217835259) ^ (r17+881327810) ^ (r18*1835641047) ^ (r19*2041872172) ^ (r20+1514321969) ^ (r21*586755734) ^ (r22+130274024) ^ (r23+680055870) ^ (r24*1181530474) ^ (r25+873821576) ^ (r26*532277300) ^ (r27+188683296) ^ (r28*1436281595) ^ (r29*1411612801) ^ (r30+2033252873) ^ (r31*594178518) ^ (r32*462648331) ^ (r33*1011936335) ^ (r34+1467225359) ^ (r35*1108678198) ^ (r36*1848747291) ^ (r37*1901984263) ^ (r38+1555359090) ^ (r39*445063455);
      r35 = 1 ^ (r0*1932340020) ^ (r1*1264449165) ^ (r2+1301512344) ^ (r3*522831050) ^ (r4+1022442426) ^ (r5+989326134) ^ (r6+60187266) ^ (r7+436560197) ^ (r8+1500075732) ^ (r9+245321109) ^ (r10*1351503050) ^ (r11*621061639) ^ (r12*1292557948) ^ (r13+76448858) ^ (r14*24270145) ^ (r15+1659363237) ^ (r16+91643953) ^ (r17*704984926) ^ (r18*2028933675) ^ (r19+1691006890) ^ (r20*71569215) ^ (r21*143294661) ^ (r22*1448112672) ^ (r23*191614093) ^ (r24+76975536) ^ (r25*668415300) ^ (r26+809004425) ^ (r27+1596499908) ^ (r28+1938080218) ^ (r29+1706465672) ^ (r30+626876347) ^ (r31+1140439037) ^ (r32+1089410700) ^ (r33+1505491647) ^ (r34+1207006652) ^ (r35+868816245) ^ (r36*914760670) ^ (r37+608288824) ^ (r38*2147041433) ^ (r39+727971434);
      r36 = 1 ^ (r0+105406109) ^ (r1+2011343918) ^ (r2+1230641513) ^ (r3+2099370418) ^ (r4*522849367) ^ (r5*1772102059) ^ (r6*896115945) ^ (r7*374181238) ^ (r8+1251367441) ^ (r9*2068866447) ^ (r10+753296572) ^ (r11*1703106561) ^ (r12*983700363) ^ (r13+954069176) ^ (r14+1545462853) ^ (r15*850700473) ^ (r16*532683060) ^ (r17*208996677) ^ (r18*1262464811) ^ (r19+2104809272) ^ (r20+1278038712) ^ (r21+1058470139) ^ (r22*1779752818) ^ (r23*29070972) ^ (r24*1337818154) ^ (r25+1732925137) ^ (r26+405451065) ^ (r27*579396162) ^ (r28*584305624) ^ (r29*971372943) ^ (r30+781396508) ^ (r31*1055607929) ^ (r32+1002573490) ^ (r33*1247824282) ^ (r34+307331631) ^ (r35+1492431066) ^ (r36*891713887) ^ (r37*2143209427) ^ (r38*1475910812) ^ (r39+1967813789);
      r37 = 1 ^ (r0*718015460) ^ (r1+1717157798) ^ (r2*1234206179) ^ (r3+1498781774) ^ (r4+799737337) ^ (r5*407255591) ^ (r6*1696878005) ^ (r7+935592391) ^ (r8*1133414898) ^ (r9*1333553246) ^ (r10*1879380596) ^ (r11+1060078654) ^ (r12+540683343) ^ (r13*618322604) ^ (r14*1920332881) ^ (r15+863521926) ^ (r16+2035142122) ^ (r17*722926415) ^ (r18+415069706) ^ (r19+1003452252) ^ (r20*574078659) ^ (r21+396452360) ^ (r22+1058779463) ^ (r23*531871711) ^ (r24+988071792) ^ (r25+916502244) ^ (r26+294143129) ^ (r27*1952257066) ^ (r28*1697339182) ^ (r29+1636301344) ^ (r30*268124438) ^ (r31*1751506438) ^ (r32*919254151) ^ (r33+1452615470) ^ (r34+738395549) ^ (r35*1090923968) ^ (r36*417377959) ^ (r37*1439910109) ^ (r38+975541674) ^ (r39+1427391777);
      r38 = 1 ^ (r0+110095688) ^ (r1+388969629) ^ (r2+1285986781) ^ (r3*1582260356) ^ (r4+936811837) ^ (r5+65553128) ^ (r6+526637077) ^ (r7+1600363529) ^ (r8*266917799) ^ (r9+1900444357) ^ (r10+892375339) ^ (r11*1219801840) ^ (r12*1382269370) ^ (r13+908445294) ^ (r14+1141690965) ^ (r15+1769111305) ^ (r16+1627259699) ^ (r17*967960346) ^ (r18*979920929) ^ (r19*1843740239) ^ (r20*1654116705) ^ (r21*515964381) ^ (r22*1576124691) ^ (r23*224445597) ^ (r24*1096314069) ^ (r25*1639096244) ^ (r26+1809821157) ^ (r27*503635841) ^ (r28*1384157104) ^ (r29*28805798) ^ (r30+1355910497) ^ (r31*1417564724) ^ (r32*543222415) ^ (r33+453653004) ^ (r34*653005284) ^ (r35*847179699) ^ (r36*1008299549) ^ (r37+1560967162) ^ (r38*2103537274) ^ (r39*1169979632);
      r39 = 1 ^ (r0+1980350270) ^ (r1+176097726) ^ (r2*481974681) ^ (r3+924124457) ^ (r4+63755227) ^ (r5*781514125) ^ (r6*345633668) ^ (r7*1746721377) ^ (r8*299456087) ^ (r9*2008166214) ^ (r10*2113486406) ^ (r11*83147765) ^ (r12+1141771669) ^ (r13+15850071) ^ (r14+1234662735) ^ (r15*251188558) ^ (r16+942483372) ^ (r17*1497976516) ^ (r18*1161507511) ^ (r19+784303805) ^ (r20+305325360) ^ (r21*1594027854) ^ (r22+1090318358) ^ (r23+186415725) ^ (r24+1294713638) ^ (r25+948963001) ^ (r26*2077102341) ^ (r27+1469024121) ^ (r28*1918099852) ^ (r29*801964590) ^ (r30+2103985468) ^ (r31*751831334) ^ (r32+679281802) ^ (r33+802389703) ^ (r34*1399304271) ^ (r35+371486771) ^ (r36*1503276609) ^ (r37*1249624114) ^ (r38*1160176910) ^ (r39+1611330645);
      r40 = 1 ^ (r0*75460407) ^ (r1+987448949) ^ (r2+161899137) ^ (r3+1485007815) ^ (r4*1677863781) ^ (r5*1283479769) ^ (r6+368697478) ^ (r7+355168005) ^ (r8+1330754021) ^ (r9+822246378) ^ (r10+1090804240) ^ (r11*1534398113) ^ (r12*1681499459) ^ (r13*1641932962) ^ (r14+811098885) ^ (r15*497910070) ^ (r16+1940345447) ^ (r17+211040942) ^ (r18+1300035515) ^ (r19*879513474) ^ (r20*836809764) ^ (r21*1104587728) ^ (r22*339710998) ^ (r23*628925593) ^ (r24*2063565160) ^ (r25*456020588) ^ (r26+1640169546) ^ (r27*595691580) ^ (r28*336872457) ^ (r29+541915432) ^ (r30*1983832369) ^ (r31*2124081487) ^ (r32*846534192) ^ (r33+1460487603) ^ (r34+344373840) ^ (r35+1716289137) ^ (r36*1539916909) ^ (r37*1045103791) ^ (r38+1007660916) ^ (r39*234398382);

#ifndef PRINT_RES_TABLE
      printk("%i", n);
#endif
    }

  return r0 ^ r1 ^ r2 ^ r3 ^ r4 ^ r5 ^ r6 ^ r7 ^ r8 ^ r9 ^ r10 ^ r11 ^ r12 ^ r13 ^ r14 ^ r15 ^ r16 ^ r17 ^ r18 ^ r19 ^ r20 ^ r21 ^ r22 ^ r23 ^ r24 ^ r25 ^ r26 ^ r27 ^ r28 ^ r29 ^ r30 ^ r31 ^ r32 ^ r33 ^ r34 ^ r35 ^ r36 ^ r37 ^ r38 ^ r39 ^ r40;
}

/* expected results for calc input 0 to 63 */
const uint32_t calc_results[64] = {
      0xe982fce8, 0xa4645327, 0x75e713a6, 0x41369d5d, 0x22befdfc, 0x796f598b, 0x936e25fa, 0xa1484e21,
      0x983b9880, 0x522a409f, 0x718f18ee, 0x8d1f17d5, 0x4c400334, 0xdeab54c3, 0x8802ccc2, 0x83aaa319,
      0xf19955d8, 0xc892c557, 0x0877ebf6, 0x44a0268d, 0x5bee7f0c, 0x8d3d3abb, 0x01073a4a, 0xab745e51,
      0x7daee4b0, 0xb585bc0f, 0x889d49fe, 0xdc2ec9c5, 0x96105c04, 0x4e4a5a33, 0xfdd36892, 0xe8b50389,
      0xdf494108, 0x01753c47, 0x369062c6, 0x5c480c3d, 0x70fecf1c, 0xba7dadeb, 0xc294849a, 0x03b62881,
      0x8b610ee0, 0x4c4fd73f, 0x5c8e2b4e, 0x0846cab5, 0xe33032d4, 0x0a10a4a3, 0xcc4e61e2, 0x6aeb1eb9,
      0xcc2c7178, 0x5821fdf7, 0xd71b1d16, 0x8b32296d, 0x4e33bb2c, 0x4662cf9b, 0x6fee7d6a, 0x7adbb1b1,
      0x28830c90, 0xc8fcd12f, 0x5489b05e, 0xd3779325, 0xfcadaea4, 0x0dbc9513, 0xf3466532, 0x5d46b0a9,
};

void *f(void *param)
{
      int n = (int)param;
      size_t p;

      pthread_barrier_wait(&bar);

#ifdef __MUTEK__
      do {
#endif
            uint32_t g = calc(n % 64);
            uint32_t e = calc_results[n % 64];
            if (g != e)
                  {
                        pthread_mutex_lock(&m);
                        printk("++FAIL++ thread:%u got:%u expected:%u\n", n, g, e);
                        pthread_mutex_unlock(&m);
                        abort();
                        while (1);
                  }
                  

#ifdef __MUTEK__
            dev_timer_busy_wait_delay(&timer_dev, rand() % timer_rq.delay);

            order_compiler_mem();
            p = pthread[n]->sched_ctx.context->preempt_cnt;

            CPU_INTERRUPT_SAVESTATE_DISABLE;
            ensure(context_set_preempt(sched_preempt_switch) == -EBUSY);
            CPU_INTERRUPT_RESTORESTATE;
      } while (p < 100 && (THREAD_COUNT - done_cnt) > 1);

      pthread_mutex_lock(&m);
      printk("Done tread:%u preempt_cnt:%u\n", n, p);
      if (p > 0)
        done_cnt++;
      pthread_mutex_unlock(&m);
#endif

      return NULL;
}

#ifdef __MUTEK__
static KROUTINE_EXEC(timeout_kr)
{
  timer_rq.deadline = 0;
  ensure(DEVICE_OP(&timer_dev, request, &timer_rq) == 0);

  uint16_t i = rand() % 256;
  if (i & 1)
    return;

  while (i--)
    asm volatile("nop");

  ensure(context_set_preempt(sched_preempt_switch) == 0);
}
#endif

void main()
{
  int i;

  CPU_INTERRUPT_SAVESTATE_DISABLE;
  ensure(context_set_preempt(sched_preempt_switch) == -EBUSY);
  CPU_INTERRUPT_RESTORESTATE;

#ifdef __MUTEK__
  ensure(!device_get_accessor_by_path(&timer_dev.base, NULL, "timer*", DRIVER_CLASS_TIMER));

  ensure(dev_timer_init_sec(&timer_dev, &timer_rq.delay, NULL, 10, 1000) == 0);

  dev_timer_rq_init_immediate(&timer_rq, timeout_kr);
  timer_rq.deadline = 0;
  timer_rq.rev = 0;

  do {
    dev_timer_value_t t;
    error_t e = DEVICE_OP(&timer_dev, request, &timer_rq);
    switch (e)
      {
      case -ETIMEDOUT:
        ensure(DEVICE_OP(&timer_dev, get_value, &t, 0) == 0);
        timer_rq.deadline = t + timer_rq.delay;
        continue;
      case 0:
        break;
      default:
        printk("timer error %i\n", e);
        goto fail;
      }
  } while (0);

#endif

#ifdef PRINT_RES_TABLE
  for (i = 0; i < 64; i++)
        printk("0x%08x,%c", calc(i), (i+1)%8 ? ' ' : '\n');

#else
  pthread_mutex_init(&m, NULL);
  pthread_barrier_init(&bar, NULL, THREAD_COUNT);

  for ( i = 0; i < THREAD_COUNT; ++i )
    pthread_create(&pthread[i], NULL, f, (void*)i);

  for ( i = 0; i < THREAD_COUNT; ++i )
    pthread_join(pthread[i], NULL);

  printk("++SUCCESS++%u++\n", done_cnt);
#endif

 fail:;
#ifdef __MUTEK__
  power_shutdown();
  power_reboot();
#endif
}

